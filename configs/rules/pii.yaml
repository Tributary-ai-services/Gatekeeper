# PII Detection Patterns
# Gatekeeper - TAS Gatekeeper Library

version: "1.0"
name: "pii"
description: "Personally Identifiable Information detection patterns"

patterns:
  # Social Security Number
  - id: "ssn"
    name: "Social Security Number"
    type: "pii"
    severity: "critical"
    description: "US Social Security Number"
    regex: '\b(?!000|666|9\d{2})\d{3}[-\s]?(?!00)\d{2}[-\s]?(?!0000)\d{4}\b'
    validation:
      type: "ssn"
      rules:
        - "first_three_not_000_666_9xx"
        - "middle_two_not_00"
        - "last_four_not_0000"
    confidence_boost:
      formatted: 0.2  # Boost if has dashes/spaces
    examples:
      - "123-45-6789"
      - "123 45 6789"
      - "123456789"
    risk_base: 0.9

  # Credit Card Numbers
  - id: "credit_card"
    name: "Credit Card Number"
    type: "pii"
    severity: "critical"
    description: "Credit card number (Visa, MasterCard, Amex, Discover)"
    regex: '\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b'
    validation:
      type: "luhn"
    confidence_boost:
      formatted: 0.1
    bin_patterns:
      visa: "^4"
      mastercard: "^5[1-5]"
      amex: "^3[47]"
      discover: "^6(?:011|5)"
    examples:
      - "4111111111111111"
      - "5555555555554444"
      - "378282246310005"
    risk_base: 0.9

  # Email Address
  - id: "email"
    name: "Email Address"
    type: "pii"
    severity: "medium"
    description: "Email address"
    regex: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
    validation:
      type: "email"
    examples:
      - "user@example.com"
      - "john.doe@company.org"
    risk_base: 0.4

  # Phone Number (US)
  - id: "phone_number"
    name: "Phone Number"
    type: "pii"
    severity: "medium"
    description: "US phone number in various formats"
    regex: '\b(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})\b'
    confidence_boost:
      formatted: 0.1
    examples:
      - "(555) 123-4567"
      - "555-123-4567"
      - "+1-555-123-4567"
    risk_base: 0.5

  # IP Address
  - id: "ip_address"
    name: "IP Address"
    type: "pii"
    severity: "low"
    description: "IPv4 address"
    regex: '\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b'
    validation:
      type: "ip"
      rules:
        - "octets_0_255"
    examples:
      - "192.168.1.1"
      - "10.0.0.1"
    risk_base: 0.3

  # Bank Account Number
  - id: "bank_account"
    name: "Bank Account Number"
    type: "pii"
    severity: "critical"
    description: "Bank account number (US routing + account)"
    regex: '\b[0-9]{9}[-\s]?[0-9]{4,17}\b'
    validation:
      type: "aba_routing"
    examples:
      - "021000021 1234567890"
    risk_base: 0.8

  # Passport Number
  - id: "passport"
    name: "Passport Number"
    type: "pii"
    severity: "high"
    description: "US Passport number"
    regex: '\b[A-Z]{1,2}[0-9]{6,9}\b'
    examples:
      - "A12345678"
      - "AB1234567"
    risk_base: 0.8

  # Driver's License
  - id: "drivers_license"
    name: "Driver's License"
    type: "pii"
    severity: "high"
    description: "US Driver's license number (state-specific patterns)"
    patterns_by_state:
      CA: '\b[A-Z][0-9]{7}\b'
      NY: '\b[0-9]{9}\b'
      TX: '\b[0-9]{8}\b'
      FL: '\b[A-Z][0-9]{12}\b'
    examples:
      - "A1234567"  # California
      - "123456789"  # New York
    risk_base: 0.7

  # Date of Birth
  - id: "date_of_birth"
    name: "Date of Birth"
    type: "pii"
    severity: "medium"
    description: "Date of birth in various formats"
    regex: '\b(?:0?[1-9]|1[0-2])[/\-](?:0?[1-9]|[12][0-9]|3[01])[/\-](?:19|20)[0-9]{2}\b'
    examples:
      - "01/15/1990"
      - "12-25-1985"
    risk_base: 0.7

  # Physical Address
  - id: "address"
    name: "Physical Address"
    type: "pii"
    severity: "medium"
    description: "US physical/mailing address"
    regex: '\b\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Boulevard|Blvd|Road|Rd|Drive|Dr|Lane|Ln|Court|Ct|Way|Circle|Cir)\.?\s*(?:#\s*\d+|(?:Apt|Suite|Ste|Unit)\s*#?\s*\d+)?\b'
    examples:
      - "123 Main Street"
      - "456 Oak Ave, Apt 7"
    risk_base: 0.6

  # Personal Name
  - id: "name"
    name: "Personal Name"
    type: "pii"
    severity: "low"
    description: "Personal name (requires context)"
    # Name detection typically requires NER, not just regex
    use_ner: true
    examples:
      - "John Smith"
      - "Jane Doe"
    risk_base: 0.5

  # Medical Record Number
  - id: "medical_record_number"
    name: "Medical Record Number"
    type: "pii"
    severity: "critical"
    description: "Healthcare medical record number"
    regex: '\b(?:MRN|MR#|Medical Record)[:\s]*[A-Z0-9]{6,12}\b'
    examples:
      - "MRN: ABC123456"
      - "MR# 123456789"
    risk_base: 0.9
    frameworks:
      - HIPAA

  # AWS Access Key
  - id: "aws_access_key"
    name: "AWS Access Key"
    type: "credential"
    severity: "critical"
    description: "AWS Access Key ID"
    regex: '\b(?:AKIA|ABIA|ACCA|ASIA)[0-9A-Z]{16}\b'
    examples:
      - "AKIAIOSFODNN7EXAMPLE"
    risk_base: 0.95

  # AWS Secret Key
  - id: "aws_secret_key"
    name: "AWS Secret Key"
    type: "credential"
    severity: "critical"
    description: "AWS Secret Access Key"
    regex: '\b[A-Za-z0-9/+=]{40}\b'
    context_required:
      - "aws"
      - "secret"
      - "key"
    examples:
      - "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    risk_base: 0.95

  # API Key (Generic)
  - id: "api_key"
    name: "API Key"
    type: "credential"
    severity: "high"
    description: "Generic API key pattern (OpenAI, GitHub, GitLab, Slack, Stripe, SendGrid, Anthropic, etc.)"
    regex: '\b(?:api[_-]?key|apikey|api[_-]?token)["\s:=]+["\']?([A-Za-z0-9_\-]{20,64})["\']?\b'
    known_prefixes:
      openai: "sk-"
      github_pat: "ghp_"
      github_oauth: "gho_"
      gitlab_pat: "glpat-"
      slack: "xox[baprs]-"
      stripe_secret: "sk_live_|sk_test_"
      stripe_pub: "pk_live_|pk_test_"
      sendgrid: "SG."
      anthropic: "sk-ant-"
      twilio: "AC"
      digitalocean: "dop_v1_"
      huggingface: "hf_"
      npm: "npm_"
      pypi: "pypi-"
      nuget: "nuget"
    examples:
      - 'api_key="abc123def456..."'
      - 'sk-abcdefghijklmnopqrstuvwxyz123456'
      - 'sk_test_<24+ alphanumeric chars>'
      - 'SG.<22 chars>.<43 chars>'
    risk_base: 0.85

  # Azure Credentials
  - id: "azure_key"
    name: "Azure Credential"
    type: "credential"
    severity: "critical"
    description: "Azure credentials (storage keys, AD client secrets, connection strings, SAS tokens)"
    patterns:
      storage_key: 'AccountKey=[A-Za-z0-9+/=]{44,88}'
      connection_string: 'DefaultEndpointsProtocol=https;AccountName=[^;]+;AccountKey=[A-Za-z0-9+/=]{44,88}'
      sas_token: '\?sv=\d{4}-\d{2}-\d{2}&s[a-z]=.*?&sig=[A-Za-z0-9%+/=]+'
      ad_secret: '(?i)(?:client[_-]?secret|azure[_-]?(?:ad|active[_-]?directory)[_-]?(?:secret|key))[\s:=]+[A-Za-z0-9~._\-]{34,}'
    examples:
      - 'DefaultEndpointsProtocol=https;AccountName=myacct;AccountKey=abc123...=='
      - 'azure_storage_key="dGVzdGtleUVYQU1QTEUwMTIzNDU2Nzg5QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZn=="'
    risk_base: 0.95

  # GCP Credentials
  - id: "gcp_key"
    name: "GCP Credential"
    type: "credential"
    severity: "critical"
    description: "Google Cloud Platform credentials (API keys, service account patterns)"
    patterns:
      api_key: '\bAIza[0-9A-Za-z_\-]{35}\b'
      labeled_key: '(?i)(?:google[_-]?(?:api[_-]?)?key|gcp[_-]?key)[\s:=]+[A-Za-z0-9_\-]{20,}'
      service_account: '"type"\s*:\s*"service_account"'
    examples:
      - 'AIzaSyC-ABC123_defGHI456_jklMNO789_pqrSTU0'
      - 'google_api_key="abcdefghijklmnopqrstuvwxyz"'
    risk_base: 0.95

  # JWT Tokens
  - id: "jwt_token"
    name: "JWT Token"
    type: "credential"
    severity: "high"
    description: "JSON Web Tokens (critical for Keycloak/OIDC)"
    regex: 'eyJ[A-Za-z0-9_-]{10,}\.eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}'
    examples:
      - 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.signature'
    risk_base: 0.85
    frameworks:
      - SECURITY

  # OAuth/PAT Tokens
  - id: "oauth_token"
    name: "OAuth/PAT Credential"
    type: "credential"
    severity: "high"
    description: "OAuth client secrets, OIDC secrets, and platform Personal Access Tokens"
    patterns:
      client_secret: '(?i)(?:client[_-]?secret|oauth[_-]?secret|oidc[_-]?secret|keycloak[_-]?secret)[\s:=]+[A-Za-z0-9_\-]{16,}'
      azure_devops_pat: '(?i)(?:azure[_-]?devops|ado)[_-]?(?:pat|token)[\s:=]+[A-Za-z0-9]{52}'
      atlassian_token: '(?i)(?:atlassian|jira|confluence)[_-]?(?:api[_-]?)?(?:key|token)[\s:=]+[A-Za-z0-9]{24,}'
      bitbucket_token: '(?i)(?:bitbucket)[_-]?(?:app[_-]?)?(?:password|token)[\s:=]+[A-Za-z0-9]{18,}'
      generic_oauth: '(?i)(?:oauth[_-]?(?:access[_-]?)?token|refresh[_-]?token|bearer[_-]?token)[\s:=]+[A-Za-z0-9_\-\.]{20,}'
    examples:
      - 'client_secret="abcdefghijklmnopqrstuvwxyz123456"'
      - 'jira_api_token="ABCDEFGHIJKLMNOPQRSTUVWXyz"'
    risk_base: 0.85

  # Private Key
  - id: "private_key"
    name: "Private Key"
    type: "credential"
    severity: "critical"
    description: "PEM-encoded private keys (RSA, DSA, EC, OPENSSH, PGP)"
    regex: '-----BEGIN (?:RSA |DSA |EC |OPENSSH |PGP )?PRIVATE KEY-----'
    examples:
      - '-----BEGIN RSA PRIVATE KEY-----'
      - '-----BEGIN PRIVATE KEY-----'
    risk_base: 0.99

  # Database Connection Strings
  - id: "connection_string"
    name: "Database Connection String"
    type: "credential"
    severity: "critical"
    description: "Database connection URIs with embedded passwords (PostgreSQL, MySQL, MongoDB, Redis)"
    patterns:
      postgresql: '(?i)postgres(?:ql)?://[^\s:]+:[^\s@]+@[^\s]+'
      mysql: '(?i)mysql://[^\s:]+:[^\s@]+@[^\s]+'
      mongodb: '(?i)mongodb(?:\+srv)?://[^\s:]+:[^\s@]+@[^\s]+'
      redis: '(?i)redis://[^\s:]+:[^\s@]+@[^\s]+'
      jdbc: '(?i)jdbc:[a-z]+://[^\s]+(?:password|pwd)\s*=\s*[^\s;&]+'
    examples:
      - 'postgresql://user:password@localhost:5432/mydb'
      - 'mongodb+srv://admin:secret@cluster0.example.net/mydb'
    risk_base: 0.92
